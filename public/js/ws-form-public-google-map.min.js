!function(e){"use strict";e.WS_Form.prototype.form_google_map=function(){var o=this,a=e("[data-google-map]:not([data-init-google-map])",this.form_canvas_obj);return!!a.length&&(!!this.form_google_maps_api_init()&&(this.google_maps=[],void a.each(function(){e(this).attr("data-init-google-map","");var a=o.get_field_id(e(this)),t=o.get_field(e(this)),_={};_.field_id=a,_.id=e(this).attr("id"),_.id_map=_.id+"-map",_.id_map_google=o.get_object_meta_value(t,"google_map_id",_.id+"-map-google"),_.id_map_google||(_.id_map_google=_.id+"-map-google"),_.obj=e(this),_.obj_map=e("#"+_.id_map,o.form_canvas_obj),_.height=o.parse_variables_process(o.get_object_meta_value(t,"google_map_height","")).output,_.height&&_.obj_map.css({height:0,overflow:"hidden","padding-bottom":_.height,position:"relative"}),_.center=o.get_object_meta_value(t,"google_map_center",""),_.lat=o.parse_variables_process(o.get_object_meta_value(t,"google_map_lat","")).output,_.lng=o.parse_variables_process(o.get_object_meta_value(t,"google_map_lng","")).output,_.zoom=o.parse_variables_process(o.get_object_meta_value(t,"google_map_zoom","")).output,_.zoom?_.zoom=parseInt(_.zoom,10):_.zoom=14,_.type=o.get_object_meta_value(t,"google_map_type",""),_.type||(_.type="roadmap"),_.search_field_id=parseInt(o.get_object_meta_value(t,"google_map_search_field_id",0),10),_.marker_icon_title=o.parse_variables_process(o.get_object_meta_value(t,"google_map_marker_icon_title","")).output,_.marker_icon_url=o.parse_variables_process(o.get_object_meta_value(t,"google_map_marker_icon_url","")).output,_.routing_icon_url_origin=o.parse_variables_process(o.get_object_meta_value(t,"google_map_routing_icon_url_origin","")).output,_.routing_polyline_color=o.parse_variables_process(o.get_object_meta_value(t,"google_map_routing_polyline_color","#418fde")).output,_.routing_polyline_weight=parseInt(o.parse_variables_process(o.get_object_meta_value(t,"google_map_routing_polyline_weight",5)).output,10),0===_.routing_polyline_weight&&(_.routing_polyline_weight=5),_.control_type=""!==o.get_object_meta_value(t,"google_map_control_type","on"),_.control_full_screen=""!==o.get_object_meta_value(t,"google_map_control_full_screen","on"),_.control_street_view=""!==o.get_object_meta_value(t,"google_map_control_street_view","on"),_.control_zoom=""!==o.get_object_meta_value(t,"google_map_control_zoom","on"),o.google_maps[a]=_,o.google_map_process(_)})))},e.WS_Form.prototype.google_map_process=function(o,a){var t=this;if(o.reposition=!0,void 0===a&&(a=(new Date).getTime()),(new Date).getTime()-a>this.timeout_google_maps)return this.error("error_timeout_google_maps"),!1;if(window.google&&window.google.maps&&window.google.maps.Map&&window.google.maps.marker&&window.google.maps.marker.AdvancedMarkerElement&&(wsf_google_maps_loaded=!0),!wsf_google_maps_loaded)return setTimeout(function(){t.google_map_process(o,a)},this.timeout_interval),!1;o.obj.attr("data-default-value",o.obj.val()),o.geocoder=new google.maps.Geocoder,o.height&&o.obj_map.css({height:0,overflow:"hidden","padding-bottom":o.height,position:"relative"}),o.geolocate_process=function(e){o.geocoder.geocode({location:e},function(a,t){"OK"===t&&a[0]?(o.search_field_obj&&o.search_field_obj.val(a[0].formatted_address),o.marker_set_position(e,a[0])):(o.search_field_obj&&o.search_field_obj.val(""),o.marker_set_position(e))})},o.set_field_value=function(e){var a=JSON.stringify(e),t=o.obj.val()!==a;o.obj.val(a),t&&o.obj.trigger("change")},o.marker_set_position=function(e,a){var t={lat:e.lat(),lng:e.lng(),zoom:o.map.getZoom(),map_type_id:o.map.getMapTypeId()};void 0!==a&&(t.place_id=(a.place_id,a.place_id),t.address=(a.formatted_address,a.formatted_address),t.name=(a.name,a.name),void 0!==a.address_components&&a.address_components.forEach(function(e){var o=e.types;-1!==o.indexOf("locality")&&(t.city=e.long_name),-1!==o.indexOf("administrative_area_level_1")&&(t.state=e.long_name),-1!==o.indexOf("country")&&(t.country=e.long_name,t.country_short=e.short_name)})),o.set_field_value(t)},o.obj.on("change",function(){var a=e(this).val();try{var _=JSON.parse(a)}catch(t){var r=a.split(",");if(2===r.length){_={lat:r[0],lng:r[1]};void 0!==r[2]&&(_.zoom=r[2]),void 0!==r[3]&&(_.map_type_id=r[3]),e(this).val(JSON.stringify(_)),o.geolocate_process(new google.maps.LatLng(parseFloat(_.lat),parseFloat(_.lng)))}else _=!1}if(!1!==_){var i=new google.maps.LatLng(parseFloat(_.lat),parseFloat(_.lng));o.search_field_obj&&_.address&&_.address!=o.search_field_obj.val()&&o.search_field_obj.val(_.address),_.zoom&&_.zoom!=o.map.getZoom()&&o.map.setZoom(_.zoom),_.map_type_id&&_.map_type_id!=o.map.getMapTypeId()&&o.map.setMapTypeId(_.map_type_id)}else{i=!1;switch(o.center){case"browser":if(!navigator.geolocation)break;navigator.geolocation.getCurrentPosition(function(e){o.obj.val(parseFloat(e.coords.latitude)+","+parseFloat(e.coords.longitude)).trigger("change")});break;case"ip":t.form_geo_get_element("lat_lng","","form_geo_map_process",{field_id:o.field_id});break;default:if(o.lat&&o.lng)i=new google.maps.LatLng(parseFloat(o.lat),parseFloat(o.lng))}!1===i&&(i=new google.maps.LatLng(29.95,-90.08)),o.map.setZoom(o.zoom),o.map.setMapTypeId(o.type)}o.marker.position=i,o.reposition&&o.map.setCenter(i)});var _={clickableIcons:!1,fullscreenControl:o.control_full_screen,gestureHandling:"cooperative",mapId:o.id_map_google,mapTypeControl:o.control_type,mapTypeId:o.type,streetViewControl:o.control_street_view,zoom:o.zoom,zoomControl:o.control_zoom},r=new google.maps.Map(o.obj_map[0],_);o.map=r,o.directions_renderer=!1,o.map.addListener("zoom_changed",function(){var e=o.obj.val();if(""!=e){try{var a=JSON.parse(e)}catch(e){return}"object"==typeof a&&(a.zoom=o.map.getZoom(),o.set_field_value(a))}}),o.map.addListener("maptypeid_changed",function(){var e=o.obj.val();if(""!=e){try{var a=JSON.parse(e)}catch(e){return}"object"==typeof a&&(a.map_type_id=o.map.getMapTypeId(),o.set_field_value(a))}}),o.map.addListener("click",function(e){o.reposition=!1,o.marker_set_position(e.latLng),o.geolocate_process(e.latLng)});var i={map:r,gmpDraggable:!0};if(o.marker_icon_url){var l=document.createElement("img");l.src=o.marker_icon_url,i.content=l}if(o.marker_icon_title&&(i.title=o.marker_icon_title),o.marker=new google.maps.marker.AdvancedMarkerElement(i),o.marker.addListener("dragend",function(e){o.reposition=!1,o.geolocate_process(e.latLng)}),o.obj.parent().find('[data-action="wsf-google-map-clear"]').on("click",function(e){e.preventDefault(),o.obj.val("").trigger("change")}),o.search_field_id){var n=t.get_section_repeatable_suffix(o.obj),s=parseInt(o.search_field_id,10),g=e('[id^="'+this.esc_selector(this.form_id_prefix+"field-"+s.toString()+n)+'"]',t.form_canvas_obj);if(n&&!g.length)g=e('[id^="'+this.esc_selector(t.form_id_prefix+"field-"+s.toString())+'"]',t.form_canvas_obj);if(g.length){o.search_field_obj=g;var p=g[0];o.search_box=new google.maps.places.SearchBox(p),o.map.addListener("bounds_changed",function(){o.search_box.setBounds(o.map.getBounds())}),o.search_box.addListener("places_changed",function(){o.reposition=!0;var e=o.search_box.getPlaces();0!=e.length&&e.forEach(function(e){e.geometry&&o.marker_set_position(e.geometry.location,e)})})}}o.obj.trigger("change")}}(jQuery);