!function(a){"use strict";a.WS_Form.prototype.form_signature=function(){var t=this,e=a('[data-type="signature"]:not([data-init-signature])',this.form_canvas_obj);if(!e.length||"undefined"==typeof SignaturePad)return!1;var r=this.framework.groups.public,i=(r.class_active,r.class_active);e.each(function(){a(this).attr("data-init-signature","");var e=a("input",a(this)),r=a("canvas",a(this)),n=r[0],s=e.attr("name"),o=e.attr("data-height");r.attr("style","height: "+o+"; padding: 0; width: 100%;");var c=a(this).attr("data-id"),g=(t.field_data_cache[c],e.attr("data-dot-size")),u=void 0!==e.attr("data-crop"),_=e.attr("data-pen-color"),v=void 0!==e.attr("data-mime")?e.attr("data-mime"):"image/png",h={maxWidth:g,penColor:_},d={signature:!1,canvas:r,canvas_element:n,input:e,name:s,mime:v,config:h,crop:u};if("image/jpeg"==v){var f=void 0!==r.attr("data-background-color")?r.attr("data-background-color"):"#ffffff";h.backgroundColor=f,d.background_color=f}t.signatures.push(d);var m=a(d.canvas_element,t.form_canvas_obj).closest('[id^="'+t.esc_selector(t.form_id_prefix)+'group-"]'),l=m.is(":visible");l||(i?m.addClass(i):m.show());var p=new SignaturePad(d.canvas_element,d.config);if(d.signature=p,t.signatures_by_name[d.name]=d,a('[data-action="wsf-signature-clear"]',a(this)).on("click",function(a){a.preventDefault(),d.signature.clear(),d.input.val("").trigger("change")}),d.canvas.on("mousedown touchstart",function(){d.input.val("1").trigger("change")}),a(document).on("keydown",function(a){d.canvas.is(":focus")&&27==a.keyCode&&(d.signature.clear(),d.input.val("").trigger("change"))}),t.signature_redraw(d.signature,d.canvas_element,!0),void 0!==e.attr("value")){var y=e.attr("value");try{var b=JSON.parse(y)}catch(a){b=[]}for(var w in b)if(b.hasOwnProperty(w)){var j=b[w];"object"==typeof j&&"string"==typeof j.base64&&p.fromDataURL(j.base64)}}l||(i?m.removeClass(i):m.hide()),t.form_validate_real_time_process(!1,!1)})},a.WS_Form.prototype.signature_redraw=function(a,t,e){if(void 0===e&&(e=!1),!e&&a.isEmpty()&&(e=!0),!e)var r=a.toDataURL();var i=Math.max(window.devicePixelRatio||1,1);t.width=t.offsetWidth*i,t.height=t.offsetHeight*i,t.getContext("2d").scale(i,i),e?a.clear():a.fromDataURL(r)},a.WS_Form.prototype.signatures_redraw=function(t,e,r){for(var i in void 0===e&&(e=!1),void 0===r&&(r=!1),this.signatures)if(this.signatures.hasOwnProperty(i)){var n=this.signatures[i];if(!1!==n.signature){var s=n.canvas_element,o=this.get_group_index(a(s,this.form_canvas_obj)),c=this.get_section_id(a(s,this.form_canvas_obj)),g=this.get_field_id(a(s,this.form_canvas_obj));(!1!==t&&o==t||!1!==e&&e==c||r==g)&&this.signature_redraw(n.signature,s)}}},a.WS_Form.prototype.signatures_clear=function(){for(var a in this.signatures)if(this.signatures.hasOwnProperty(a)){var t=this.signatures[a];t.signature.clear(),t.input.val("").trigger("change")}},a.WS_Form.prototype.signature_clear_by_name=function(a){var t=void 0!==this.signatures_by_name[a]&&this.signatures_by_name[a];!1!==t&&(t.signature.clear(),t.input.val("").trigger("change"))},a.WS_Form.prototype.signature_get_response_by_name=function(a){var t=void 0!==this.signatures_by_name[a]&&this.signatures_by_name[a];return!1!==t&&""!==t.input.val()},a.WS_Form.prototype.signature_form_post=function(){for(var t in this.signatures)if(this.signatures.hasOwnProperty(t)){var e=this.signatures[t];if(e.signature.isEmpty()||0==e.canvas_element.width||0==e.canvas_element.height)a('[name="'+this.esc_selector(e.name)+'"]',this.form_canvas_obj).val("");else{var r=e.signature.toDataURL(e.mime);a('[name="'+this.esc_selector(e.name)+'"]',this.form_canvas_obj).val(r)}}}}(jQuery);