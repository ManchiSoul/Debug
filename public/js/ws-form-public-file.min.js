!function(e){"use strict";e.WS_Form.prototype.form_file=function(){var t=this;e('input[type="file"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field(e(this)),i=!1;if("on"===t.get_object_meta_value(a,"file_preview",!1)){var r=t.get_object_meta_value(a,"orientation",!1),s=ws_form_settings.skin_grid_gutter;switch(r){case"grid":var o=t.get_field_value_fallback(a.type,!1,"class_orientation_wrapper",[]),n=t.get_field_value_fallback(a.type,!1,"class_orientation_row",[]);o.push("wsf-file-preview");var l=o.join(" "),_=t.column_class_array(a,"orientation_breakpoint"),d=(_=n.concat(_)).join(" "),p="",c="display: block; height: revert; margin-top: "+s+"px; width: 100%;";break;case"horizontal":l="wsf-file-preview",d="";var f=t.get_object_meta_value(a,"file_preview_width",!1);p="display: inline-block; -webkit-margin-end: "+s+"px; margin-inline-end: "+s+"px; vertical-align: top;"+(!1!==f?" width: "+f+";":""),c="display: block; height: revert; margin-top: "+s+"px; max-width: 100%; width: revert;";break;default:l="wsf-file-preview",d="",p="",c="display: block; height: revert; margin-top: "+s+"px; max-width: 100%; width: 100%;"}i=e("<div"+(""!=l?' class="'+t.esc_attr(l)+'"':"")+"></div>");e(this).closest("[data-type]").append(i)}e(this).on("change",function(){var a=e(this)[0].files;!1!==i&&t.form_file_preview(a,i,d,p,c)}),e(this).attr("data-init-file","")}),"undefined"!=typeof Dropzone&&e('[data-file-type="dropzonejs"]:not([data-init-file])',this.form_canvas_obj).each(function(){var a=t.get_field_id(e(this)),i=t.get_field(e(this));Dropzone.autoDiscover=!1;var r=e(this),s=e(this).attr("id"),o=void 0!==e(this).attr("multiple"),n=e('[data-source="post_progress"]',this.form_canvas_obj),l=t.get_object_meta_value(i,"orientation",!1),_=null,d=null,p=ws_form_settings.skin_grid_gutter;switch(l){case"grid":var c=t.get_field_value_fallback("file",!1,"class_orientation_wrapper",[]);c.push("wsf-dropzonejs-previews");var f=c.join(" "),u=t.get_field_value_fallback("file",!1,"class_orientation_row",[]),v=t.column_class_array(i,"orientation_breakpoint");(v=u.concat(v)).push("wsf-dropzonejs-preview");var m=v.join(" "),h="margin-bottom: "+p+"px;",g="display: block; height: revert; width: 100%;";break;case"horizontal":f="wsf-dropzonejs-previews",m="wsf-dropzonejs-preview";var w=t.get_object_meta_value(i,"file_preview_width",!1),b=(h="display: inline-block; margin-bottom: "+p+"px; -webkit-margin-end: "+p+"px; margin-inline-end: "+p+"px; vertical-align: top;"+(!1!==w?" width: "+w+";":""),g="display: block; width: revert; height: revert; max-width: 100%;",parseInt(t.replace_all(w,"px",""),10));_=b,d=b;break;default:f="wsf-dropzonejs-previews",m="wsf-dropzonejs-preview",h="margin-bottom: "+p+"px;",g="display: block; height: revert; max-width: 100%; width: 100%;"}e("#"+s+"-dropzonejs-previews").attr("class",f);var j=t.get_field_value_fallback("file",!1,"mask_invalid_feedback_dropzonejs_preview",""),z=[];z.invalid_feedback_id="#"+s+"-dropzone-error-message";var y=t.get_field_value_fallback("file",!1,"class_invalid_feedback",[]);z.invalid_feedback_class=y.join(" "),z.invalid_feedback="",z.attributes=" data-dz-errormessage";var k=t.mask_parse(j,z),x=t.get_field_value_fallback("file",!1,"mask_help_dropzonejs_preview",""),O=[];O.help_id="#"+s+"-dropzone-name";var S=t.get_field_value_fallback("file",!1,"class_help_post",[]);O.help_class=S.join(" "),O.help="",O.help_append="",O.attributes=" data-dz-name";var L=t.mask_parse(x,O);O.attributes=" data-dz-size";var F=t.mask_parse(x,O);O.attributes="",O.help='<a href="#" data-dz-remove>'+t.language("dropzonejs_remove")+"</a>";var D=t.mask_parse(x,O),I='<div class="'+(m?" "+t.esc_attr(m):"")+(""!=h?'" style="'+t.esc_attr(h)+'"':"")+'">';I+='<img data-dz-thumbnail style="'+(g?" "+g:"")+'" />',I+=k,I+=L,I+=F,I+='<div class="wsf-progress"><div class="wsf-upload" data-dz-uploadprogress></div></div>',I+=D,I+="</div>";var W={url:ws_form_settings.url_ajax+"field/"+a+"/dropzonejs/",paramName:"file",uploadMultiple:o,previewTemplate:I,previewsContainer:"#"+s+"-dropzonejs-previews",thumbnailWidth:_,thumbnailHeight:d,init:function(){this.add_custom_file=function(e,t,a){this.files.push(e),this.emit("addedfile",e),this.emit("thumbnail",e,t),this.emit("processing",e),this.emit("success",e,a,!1),this.emit("complete",e),this.element.classList.add("dz-started")},this.ajax_complete=function(){t.dropzonejs_processes>0&&t.dropzonejs_processes--,0===t.dropzonejs_processes&&(t.form_post_unlock("progress",!1,!0),n.each(function(){t.form_progress_set_value(e(this),0)}))},this.input_update=function(){var e={};for(var t in A.files)if(A.files.hasOwnProperty(t)){var a=A.files[t];"success"===a.status&&void 0!==a.upload.uuid&&void 0!==a.upload.attachment_id&&(e[a.upload.uuid]=a.upload.attachment_id)}r.val(Object.keys(e).length?JSON.stringify({type:"dropzonejs",attachment_ids:e}):"").trigger("change")},this.on("addedfile",function(e){this.element.classList.add("dz-started"),t.dropzonejs_processes++})}},H=t.get_object_meta_value(i,"accept","");""!=H&&(W.acceptedFiles=H);var M=parseInt(t.get_object_meta_value(i,"file_max",0),10);W.maxFiles=o?M>0?M:null:1;var N=parseInt(t.get_object_meta_value(i,"file_max_size",0),10);N>0&&(W.maxFilesize=N);var R=parseInt(t.get_object_meta_value(i,"file_image_max_width",0),10);R>0&&(W.resizeWidth=R);var U=parseInt(t.get_object_meta_value(i,"file_image_max_height",0),10);U>0&&(W.resizeHeight=U);var J="on"==t.get_object_meta_value(i,"file_image_crop","");W.resizeMethod=J?"crop":"contain";var T=parseInt(t.get_object_meta_value(i,"file_image_max_height",100),10);T>0&&(W.resizeQuality=T/100);var C=t.get_object_meta_value(i,"file_image_mime","");""!=C&&(W.resizeMimeType=C);var E=t.get_object_meta_value(i,"file_capture","");""!=E&&(W.capture=E);var P=parseInt(t.get_object_meta_value(i,"file_timeout",""),10);P>0&&(W.timeout=P);var A=new Dropzone("#"+s+"-dropzonejs",W);e("#"+s+"-dropzonejs").on("click mousedown mouseup mouseover mouseout touchstart touchend touchmove touchcancel",function(t){e("#"+s).trigger(t.type)}),o&&t.get_object_meta_value(i,"dropzonejs_sortable","on")&&e("#"+s+"-dropzonejs").sortable({items:".wsf-dropzonejs-preview",cursor:"move",tolerance:"pointer",forceHelperSize:!0,cancel:"[data-dz-remove]",start:function(e,a){t.dropzonejs_index_dragged_from=a.helper.index(),a.placeholder.attr("style",h);var i=a.helper.height(),r=a.helper.outerWidth();a.placeholder.css({width:r+"px",height:i+"px"})},stop:function(e,a){var i=t.dropzonejs_index_dragged_from,r=a.item.index();if(r>=A.files.length)for(var s=r-A.files.length;1+s--;)A.files.push(void 0);A.files.splice(r,0,A.files.splice(i,1)[0]),A.input_update()}}),e(this).attr("data-default-value",e(this).val()),t.form_file_dropzonejs_populate(e(this),!1),t.dropzonejs_processes=0,A.on("sending",function(e,a,i){ws_form_settings.wsf_nonce&&i.append(ws_form_settings.wsf_nonce_field_name,ws_form_settings.wsf_nonce),ws_form_settings.x_wp_nonce&&i.append("_wpnonce",ws_form_settings.x_wp_nonce),i.append("id",t.form_id),i.append("preview",t.form_canvas_obj[0].hasAttribute("data-preview"))}),A.on("success",function(a,i,s){if(!a.wsf_preload)if(void 0!==i.error&&!1===i.error){if(this.options.success(a),"object"==typeof i.file_objects&&i.file_objects.length>0){try{var o=JSON.parse(r.val()).attachment_ids}catch(e){o={}}var n=!1;for(var l in i.file_objects)if(i.file_objects.hasOwnProperty(l)){var _=i.file_objects[l],d=_.attachment_id;if(-1===Object.values(o).indexOf(d)){n=d;break}}if(!1===n)return;if(a.upload.attachment_id=n,"object"==typeof _&&void 0!==_.preview&&void 0!==a.previewElement){var p=e("img[data-dz-thumbnail]",e(a.previewElement));p.length&&void 0===p.attr("src")&&p.attr("src",_.preview)}}this.input_update()}else this.options.error(a,i.error_message?i.error_message:t.language("error_file_upload"))}),A.on("processing",function(){t.form_post_lock("progress",!0,!0)}),A.on("totaluploadprogress",function(a){n.each(function(){t.form_progress_set_value(e(this),a/100)}),a>99&&e(".wsf-progress",e(this.element)).addClass("wsf-progress-success")}),A.on("complete",function(){this.ajax_complete()}),A.on("canceled",function(){this.ajax_complete()}),A.on("removedfile",function(e){this.input_update(),this.ajax_complete()}),A.on("error",function(a,i){switch(typeof i){case"string":var r=i;try{var s=JSON.parse(i);if(null!==s&&s.error&&s.error_message)r=s.error_message}catch(e){}break;case"object":if(i.error&&i.error_message)r=i.error_message;else r=JSON.stringify(i);break;default:r=t.language("error_file_upload")}e(a.previewElement).find("[data-dz-errormessage]").html(r)});var Q=r.attr("disabled");Q||(Q=Q||e(this).closest("fieldset").attr("disabled")),Q&&A.disable(),e(this).attr("data-init-file","")})},e.WS_Form.prototype.form_file_dropzonejs_populate=function(t,a){var i=e("+ .dropzone",t)[0].dropzone;if(i.removeAllFiles(!0),t.val(""),!a){var r=t.attr("data-default-value");if(""!=r){try{var s=JSON.parse(r)}catch(e){s=[]}for(var o in s)if(s.hasOwnProperty(o)){var n=s[o];if(void 0!==n.name){var l={processing:!0,accepted:!0,name:n.name,size:n.size,type:n.type,upload:{uuid:n.uuid,attachment_id:n.attachment_id},status:Dropzone.SUCCESS,wsf_preload:!0},_=void 0!==n.preview?n.preview:n.url;l.upload.uuid||(l.upload.uuid=Dropzone.uuidv4()),i.add_custom_file(l,_,{status:"success"})}}i.input_update()}}},e.WS_Form.prototype.form_file_preview=function(t,a,i,r,s){var o=[],n="<div"+(""!=i?' class="'+this.esc_attr(i)+'"':"")+(""!=r?' style="'+this.esc_attr(r)+'"':"")+">";a.html("");for(var l in t)if(t.hasOwnProperty(l)){var _=t[l];switch(_.type){case"image/apng":case"image/bmp":case"image/gif":case"image/jpeg":case"image/png":case"image/svg+xml":case"image/tiff":case"image/webp":case"image/x-icon":o[l]=new FileReader,o[l].wsf_file_index=l,o[l].onload=function(i){var r=this.wsf_file_index,o=i.target.result,l=t[r].name,_=e("<img />");_.attr("src",o),_.attr("alt",l),_.attr("title",l),_.attr("style",s),a.append(n+_[0].outerHTML+"</div>")},o[l].readAsDataURL(_);break;case"video/avi":case"video/mp4":case"video/ogg":case"video/ogm":case"video/ogv":case"video/webm":var d=URL.createObjectURL(_),p=e("<video controls />");p.attr("src",d),p.attr("style",s),p.html(this.language("error_not_supported_video")),a.append(n+p[0].outerHTML+"</div>");break;case"audio/aac":case"audio/aacp":case"audio/flac":case"audio/mp4":case"audio/mpeg":case"audio/ogg":case"audio/wav":case"audio/webm":var c=URL.createObjectURL(_),f=e("<audio controls />");f.attr("src",c),f.attr("style",s+" height: 40px;"),f.html(this.language("error_not_supported_audio")),a.append(n+f[0].outerHTML+"</div>")}}},e.WS_Form.prototype.file_get_count_by_field_id=function(t){var a=e('[name^="'+this.esc_selector(ws_form_settings.field_prefix+t)+'["]',this.form_canvas_obj);if(!a.length)return!1;var i=!1;return a.each(function(){if(e(this).attr("data-file-type")&&"dropzonejs"===e(this).attr("data-file-type")){var t=e(this).closest('[data-type="file"]');if(t){var a=e(".dropzone",t)[0].dropzone;a.files&&(i+=a.files.length)}}else i+=this.files.length}),i}}(jQuery);